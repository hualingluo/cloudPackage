name: ğŸ¬ æŠ–å‰§ Douju - Flutter EXE è‡ªåŠ¨åŒ–æ‰“åŒ…

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. åˆå§‹åŒ– Flutter é¡¹ç›®
        run: |
          flutter create --platforms=windows player_app
          cd player_app
          flutter config --enable-windows-desktop

      - name: 4. æ³¨å…¥æ’­æ”¾å™¨å¼•æ“ä¸æ•°æ®
        shell: pwsh
        run: |
          mkdir player_app/assets
          
          if (Test-Path "project.json") {
              copy project.json player_app\assets\movie_config.json
          } else {
              copy metadata.json player_app\assets\movie_config.json
          }
          
          # ä½¿ç”¨å•å¼•å·Here-Stringé¿å…è½¬ä¹‰é—®é¢˜
          @'
          import 'dart:convert';
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';

          void main() => runApp(const MovieApp());

          class MovieApp extends StatelessWidget {
            const MovieApp({super.key});
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Douju Player',
                debugShowCheckedModeBanner: false,
                theme: ThemeData(
                  brightness: Brightness.dark,
                  primarySwatch: Colors.cyan,
                  useMaterial3: true,
                ),
                home: const MoviePlayer(),
              );
            }
          }

          class MoviePlayer extends StatefulWidget {
            const MoviePlayer({super.key});
            @override
            State<MoviePlayer> createState() => _MoviePlayerState();
          }

          class _MoviePlayerState extends State<MoviePlayer> {
            Map<String, dynamic>? project;
            String? currentId;

            @override
            void initState() {
              super.initState();
              _loadProject();
            }

            Future<void> _loadProject() async {
              try {
                final String response = await rootBundle.loadString('assets/movie_config.json');
                final data = await json.decode(response);
                setState(() {
                  project = data;
                  currentId = 'start';
                });
              } catch (e) {
                debugPrint("åŠ è½½å¤±è´¥: $e");
              }
            }

            @override
            Widget build(BuildContext context) {
              if (project == null) return const Scaffold(body: Center(child: CircularProgressIndicator()));
              
              final nodes = project!['nodes'] as Map<String, dynamic>?;
              final node = nodes?[currentId];
              
              if (node == null) return const Scaffold(body: Center(child: Text('å‰§ç»ˆæˆ–æ•°æ®é”™è¯¯')));

              return Scaffold(
                backgroundColor: Colors.black,
                body: Stack(
                  children: [
                    Positioned.fill(
                      child: (node['mediaSrc'] != null && node['mediaSrc'] != "")
                        ? Image.network(node['mediaSrc'], fit: BoxFit.cover, 
                            errorBuilder: (c, e, s) => Container(color: Colors.grey[900]))
                        : Container(color: Colors.black),
                    ),
                    
                    Positioned.fill(
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [Colors.transparent, Colors.black.withOpacity(0.9)],
                          ),
                        ),
                      ),
                    ),

                    Align(
                      alignment: Alignment.bottomCenter,
                      child: Container(
                        padding: const EdgeInsets.all(40),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(node['title'] ?? '', style: const TextStyle(fontSize: 32, fontWeight: FontWeight.bold, color: Colors.cyanAccent)),
                            const SizedBox(height: 20),
                            Text(node['content'] ?? '', style: const TextStyle(fontSize: 18, height: 1.6, color: Colors.white70)),
                            const SizedBox(height: 40),
                            Wrap(
                              spacing: 16,
                              runSpacing: 16,
                              children: (node['options'] as List).map((opt) => ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 20),
                                  backgroundColor: Colors.white.withOpacity(0.1),
                                  foregroundColor: Colors.white,
                                  side: const BorderSide(color: Colors.white24),
                                ),
                                onPressed: () => setState(() => currentId = opt['targetId']),
                                child: Text(opt['label'], style: const TextStyle(fontSize: 16)),
                              )).toList(),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          '@ | Out-File -FilePath player_app/lib/main.dart -Encoding utf8

      - name: 5. æ³¨å†Œèµ„æºæ–‡ä»¶
        shell: pwsh
        run: |
          cd player_app
          # æ›´å®‰å…¨çš„æ–¹å¼ä¿®æ”¹pubspec.yaml
          $content = Get-Content pubspec.yaml -Raw
          $content = $content -replace '(?m)^  assets:.*$', "  assets:\n    - assets/movie_config.json"
          $content | Set-Content pubspec.yaml -Encoding utf8

      - name: 6. ç¼–è¯‘ Release EXE
        run: |
          cd player_app
          flutter pub get
          flutter analyze  # å…ˆåˆ†æä»£ç ï¼Œç¡®ä¿è¯­æ³•æ­£ç¡®
          flutter build windows --release

      - name: 7. æ•´ç†å¹¶ä¸Šä¼ äº§ç‰©
        shell: pwsh
        run: |
          mkdir output
          xcopy player_app\build\windows\x64\runner\Release\* output\ /E /H /C /I
          Compress-Archive -Path output\* -DestinationPath Douju_Player_Windows.zip

      - name: 8. å‘å¸ƒåˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Douju-Flutter-EXE-Build
          path: Douju_Player_Windows.zip
          retention-days: 7
