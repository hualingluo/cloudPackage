name: ğŸ¬ æŠ–å‰§ Douju - Flutter EXE è‡ªåŠ¨åŒ–æ‰“åŒ…

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. åˆå§‹åŒ– Flutter é¡¹ç›®
        run: |
          flutter create --platforms=windows player_app
          cd player_app
          flutter config --enable-windows-desktop

      - name: 4. æ³¨å…¥æ™ºèƒ½æ’­æ”¾å™¨å¼•æ“ä¸æ•°æ®
        shell: pwsh
        run: |
          # ç¡®ä¿ assets ç›®å½•å­˜åœ¨
          $assetsPath = "player_app/assets"
          if (!(Test-Path $assetsPath)) { New-Item -ItemType Directory -Path $assetsPath }
          
          # ä¼˜å…ˆä½¿ç”¨å·¥ç¨‹å¯¼å‡ºçš„ project.jsonï¼Œå¦åˆ™å›é€€åˆ° metadata.json
          if (Test-Path "project.json") {
              Copy-Item "project.json" -Destination "player_app/assets/movie_config.json" -Force
          } else {
              Copy-Item "metadata.json" -Destination "player_app/assets/movie_config.json" -Force
          }
          
          # å†™å…¥æ”¹è¿›åçš„ Dart æºç 
          $dartCode = @'
          import 'dart:convert';
          import 'dart:async';
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:video_player/video_player.dart';

          void main() {
            WidgetsFlutterBinding.ensureInitialized();
            runApp(const MovieApp());
          }

          class MovieApp extends StatelessWidget {
            const MovieApp({super.key});
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Douju Player Pro',
                debugShowCheckedModeBanner: false,
                theme: ThemeData(
                  brightness: Brightness.dark,
                  primaryColor: Colors.cyan,
                  useMaterial3: true,
                  scaffoldBackgroundColor: Colors.black,
                ),
                home: const MoviePlayer(),
              );
            }
          }

          class MoviePlayer extends StatefulWidget {
            const MoviePlayer({super.key});
            @override
            State<MoviePlayer> createState() => _MoviePlayerState();
          }

          class _MoviePlayerState extends State<MoviePlayer> {
            Map<String, dynamic>? project;
            String? currentId;
            VideoPlayerController? _videoController;
            bool _isInitialized = false;
            String? _errorMessage;
            bool _isLoading = true;

            @override
            void initState() {
              super.initState();
              _loadProject();
            }

            @override
            void dispose() {
              _videoController?.dispose();
              super.dispose();
            }

            Future<void> _loadProject() async {
              try {
                final String response = await rootBundle.loadString('assets/movie_config.json');
                final data = await json.decode(response);
                setState(() {
                  project = data;
                  currentId = 'start';
                });
                _setupMedia();
              } catch (e) {
                setState(() { _errorMessage = "é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: $e"; _isLoading = false; });
              }
            }

            Future<void> _setupMedia() async {
              final nodes = project?['nodes'] as Map<String, dynamic>?;
              final node = nodes?[currentId];
              if (node == null) return;

              setState(() { 
                _isInitialized = false; 
                _isLoading = true; 
                _errorMessage = null; 
              });

              await _videoController?.dispose();
              _videoController = null;

              String mediaSrc = (node['mediaSrc'] ?? '').toString();
              final String mediaType = (node['mediaType'] ?? 'none').toString();
              
              // è‡ªåŠ¨å°† http è½¬æ¢ä¸º https ä»¥è§„é¿ Windows å®‰å…¨ç­–ç•¥æ‹¦æˆªï¼ˆå¯é€‰ï¼Œå–å†³äºæºæ˜¯å¦æ”¯æŒï¼‰
              // if (mediaSrc.startsWith('http://')) { mediaSrc = mediaSrc.replaceFirst('http://', 'https://'); }

              bool shouldPlayVideo = (mediaType == 'video') || (mediaSrc.toLowerCase().contains('.mp4'));

              if (shouldPlayVideo && mediaSrc.isNotEmpty) {
                try {
                  _videoController = VideoPlayerController.networkUrl(Uri.parse(mediaSrc));
                  
                  // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
                  await _videoController!.initialize().timeout(const Duration(seconds: 15));
                  await _videoController!.setLooping(true);
                  await _videoController!.setVolume(1.0);
                  await _videoController!.play();
                  
                  if (mounted) {
                    setState(() { _isInitialized = true; _isLoading = false; });
                  }
                } catch (e) {
                  if (mounted) {
                    setState(() { 
                      _errorMessage = "è§†é¢‘åŠ è½½å¤±è´¥: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–èµ„æºåœ°å€\n$mediaSrc"; 
                      _isLoading = false; 
                    });
                  }
                }
              } else {
                setState(() { _isLoading = false; });
              }
            }

            void _onOptionPressed(String targetId) {
              if (targetId.isEmpty) return;
              setState(() {
                currentId = targetId;
              });
              _setupMedia();
            }

            @override
            Widget build(BuildContext context) {
              if (project == null) return const Scaffold(body: Center(child: CircularProgressIndicator(color: Colors.cyan)));
              
              final nodes = project!['nodes'] as Map<String, dynamic>?;
              final node = nodes?[currentId];
              
              if (node == null) return const Scaffold(body: Center(child: Text('å‰§ç»ˆ', style: TextStyle(fontSize: 32))));

              return Scaffold(
                body: Stack(
                  children: [
                    // èƒŒæ™¯å±‚ï¼šè§†é¢‘æˆ–å›¾ç‰‡
                    Positioned.fill(child: _buildMediaBackground(node)),
                    
                    // æ¸å˜è’™å±‚
                    Positioned.fill(
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [Colors.transparent, Colors.black.withOpacity(0.8)],
                          ),
                        ),
                      ),
                    ),

                    // åŠ è½½æŒ‡ç¤ºå™¨
                    if (_isLoading)
                      const Center(child: CircularProgressIndicator(color: Colors.cyanAccent)),

                    // å†…å®¹å±‚
                    Align(
                      alignment: Alignment.bottomCenter,
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 60, vertical: 80),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              node['title'] ?? '', 
                              style: const TextStyle(
                                fontSize: 48, 
                                fontWeight: FontWeight.bold, 
                                color: Colors.cyanAccent, 
                                shadows: [Shadow(blurRadius: 15, color: Colors.black)]
                              )
                            ),
                            const SizedBox(height: 24),
                            Text(
                              node['content'] ?? '', 
                              style: const TextStyle(
                                fontSize: 22, 
                                height: 1.6, 
                                color: Colors.white, 
                                shadows: [Shadow(blurRadius: 8, color: Colors.black)]
                              )
                            ),
                            const SizedBox(height: 50),
                            Wrap(
                              spacing: 20,
                              runSpacing: 20,
                              children: (node['options'] as List? ?? []).map((opt) => ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  padding: const EdgeInsets.symmetric(horizontal: 48, vertical: 28),
                                  backgroundColor: Colors.white.withOpacity(0.05),
                                  foregroundColor: Colors.white,
                                  side: const BorderSide(color: Colors.cyanAccent, width: 1),
                                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                                  elevation: 0,
                                ),
                                onPressed: () => _onOptionPressed(opt['targetId']?.toString() ?? ''),
                                child: Text(opt['label']?.toString() ?? 'ç»§ç»­', style: const TextStyle(fontSize: 20)),
                              )).toList(),
                            ),
                          ],
                        ),
                      ),
                    ),
                    
                    // é”™è¯¯æç¤º
                    if (_errorMessage != null)
                      Positioned(
                        top: 20,
                        left: 20,
                        right: 20,
                        child: Container(
                          padding: const EdgeInsets.all(12),
                          color: Colors.red.withOpacity(0.7),
                          child: Text(_errorMessage!, textAlign: TextAlign.center, style: const TextStyle(color: Colors.white, fontSize: 12)),
                        ),
                      ),
                  ],
                ),
              );
            }

            Widget _buildMediaBackground(Map<String, dynamic> node) {
              final mediaSrc = node['mediaSrc']?.toString() ?? '';
              
              if (_isInitialized && _videoController != null) {
                return SizedBox.expand(
                  child: FittedBox(
                    fit: BoxFit.cover,
                    child: SizedBox(
                      width: _videoController!.value.size.width,
                      height: _videoController!.value.size.height,
                      child: VideoPlayer(_videoController!),
                    ),
                  ),
                );
              } else if (mediaSrc.isNotEmpty) {
                return Image.network(
                  mediaSrc, 
                  fit: BoxFit.cover, 
                  errorBuilder: (c, e, s) => Container(
                    color: Colors.black,
                    child: const Center(child: Icon(Icons.broken_image, color: Colors.white24, size: 64)),
                  )
                );
              }
              return Container(color: Colors.black);
            }
          }
          '@
          
          # ç¼©è¿›å¤„ç†å¹¶å†™å…¥æ–‡ä»¶
          $dartCode.Trim() -replace '(?m)^\s{10}', '' | Out-File -FilePath "player_app/lib/main.dart" -Encoding utf8

      - name: 5. æ³¨å†Œèµ„æºä¸ä¾èµ–
        shell: pwsh
        run: |
          cd player_app
          # æ˜¾å¼æ·»åŠ æœ€æ–°ç‰ˆä¾èµ–
          flutter pub add video_player
          # åœ¨ pubspec.yaml ä¸­æ­£ç¡®æ³¨å…¥ assets
          $content = Get-Content pubspec.yaml
          $newContent = $content -replace '# assets:', "assets:`n    - assets/movie_config.json"
          Set-Content pubspec.yaml $newContent

      - name: 6. ç¼–è¯‘ Release EXE
        run: |
          cd player_app
          flutter pub get
          flutter build windows --release

      - name: 7. æ•´ç†å¹¶æ‰“åŒ…äº§ç‰©
        shell: pwsh
        run: |
          if (Test-Path "output") { Remove-Item -Recurse -Force "output" }
          New-Item -ItemType Directory -Path "output"
          # æ‹·è´ç¼–è¯‘åçš„äºŒè¿›åˆ¶åŠå…¶ä¾èµ– DLL
          Copy-Item "player_app/build/windows/x64/runner/Release/*" -Destination "output/" -Recurse
          # å‹ç¼©
          Compress-Archive -Path "output/*" -DestinationPath "Douju_Player_Windows.zip" -Force

      - name: 8. ä¸Šä¼  Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Douju-Flutter-EXE-Build
          path: Douju_Player_Windows.zip
          retention-days: 7
