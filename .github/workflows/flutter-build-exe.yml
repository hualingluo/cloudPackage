name: ğŸ¬ æŠ–å‰§ Douju - Flutter EXE è‡ªåŠ¨åŒ–æ‰“åŒ…

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. åˆå§‹åŒ– Flutter é¡¹ç›®
        run: |
          flutter create --platforms=windows player_app
          cd player_app
          flutter config --enable-windows-desktop

      - name: 4. æ³¨å…¥æ™ºèƒ½æ’­æ”¾å™¨å¼•æ“ä¸æ•°æ®
        shell: pwsh
        run: |
          $assetsPath = "player_app/assets"
          if (!(Test-Path $assetsPath)) { New-Item -ItemType Directory -Path $assetsPath }
          
          if (Test-Path "project.json") {
              Copy-Item "project.json" -Destination "player_app/assets/movie_config.json" -Force
          } else {
              Copy-Item "metadata.json" -Destination "player_app/assets/movie_config.json" -Force
          }
          
          # å†™å…¥å…·æœ‰å¼ºå®¹é”™èƒ½åŠ›å’Œ Windows ä¼˜åŒ–çš„æ’­æ”¾å¼•æ“
          $dartCode = @'
          import 'dart:convert';
          import 'dart:async';
          import 'dart:io';
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:video_player/video_player.dart';

          void main() {
            HttpOverrides.global = MyHttpOverrides();
            WidgetsFlutterBinding.ensureInitialized();
            runApp(const MovieApp());
          }

          class MyHttpOverrides extends HttpOverrides {
            @override
            HttpClient createHttpClient(SecurityContext? context) {
              return super.createHttpClient(context)
                ..badCertificateCallback = (X509Certificate cert, String host, int port) => true;
            }
          }

          class MovieApp extends StatelessWidget {
            const MovieApp({super.key});
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Douju Player Pro',
                debugShowCheckedModeBanner: false,
                theme: ThemeData(
                  brightness: Brightness.dark,
                  primaryColor: Colors.cyan,
                  useMaterial3: true,
                  scaffoldBackgroundColor: Colors.black,
                  textTheme: const TextTheme(
                    bodyMedium: TextStyle(fontFamily: 'Segoe UI', color: Colors.white),
                  ),
                ),
                home: const MoviePlayer(),
              );
            }
          }

          class MoviePlayer extends StatefulWidget {
            const MoviePlayer({super.key});
            @override
            State<MoviePlayer> createState() => _MoviePlayerState();
          }

          class _MoviePlayerState extends State<MoviePlayer> with TickerProviderStateMixin {
            Map<String, dynamic>? project;
            String? currentId;
            VideoPlayerController? _videoController;
            bool _isInitialized = false;
            String? _errorMessage;
            String _loadingStatus = "ç­‰å¾…è¾“å…¥...";
            bool _isLoading = true;
            Timer? _timeoutTimer;

            @override
            void initState() {
              super.initState();
              _loadProject();
            }

            @override
            void dispose() {
              _timeoutTimer?.cancel();
              _videoController?.dispose();
              super.dispose();
            }

            Future<void> _loadProject() async {
              try {
                final String response = await rootBundle.loadString('assets/movie_config.json');
                final data = await json.decode(response);
                setState(() {
                  project = data;
                  currentId = 'start';
                });
                _setupMedia();
              } catch (e) {
                setState(() { _errorMessage = "æ— æ³•è§£æé…ç½®æ–‡ä»¶: $e"; _isLoading = false; });
              }
            }

            Future<void> _setupMedia() async {
              _timeoutTimer?.cancel();
              final nodes = project?['nodes'] as Map<String, dynamic>?;
              final node = nodes?[currentId];
              if (node == null) return;

              setState(() { 
                _isInitialized = false; 
                _isLoading = true; 
                _errorMessage = null; 
                _loadingStatus = "æ­£åœ¨æ£€ç´¢èŠ‚ç‚¹èµ„æº...";
              });

              await _videoController?.dispose();
              _videoController = null;

              String mediaSrc = (node['mediaSrc'] ?? '').toString();
              bool isVideo = mediaSrc.toLowerCase().contains('.mp4') || (node['mediaType'] == 'video');

              if (isVideo && mediaSrc.isNotEmpty) {
                // å¼€å¯è¶…æ—¶é¢„è­¦ï¼Œå¦‚æœ 8 ç§’æ²¡ååº”ï¼Œè‡ªåŠ¨è®©æ–‡æœ¬å±‚å…ˆå‡ºæ¥
                _timeoutTimer = Timer(const Duration(seconds: 8), () {
                  if (_isLoading && mounted) {
                    setState(() { _loadingStatus = "è§£æè¾ƒæ…¢ï¼Œå·²å¼€å¯æ–‡æœ¬æ¨¡å¼..."; });
                  }
                });

                bool success = await _tryInitVideo(mediaSrc, "æ­£åœ¨è§£æåª’ä½“æµ...");
                
                // å¤±è´¥é‡è¯•é€»è¾‘ (HTTP/HTTPS è‡ªé€‚åº”)
                if (!success && mediaSrc.startsWith('http://')) {
                  String secureSrc = mediaSrc.replaceFirst('http://', 'https://');
                  success = await _tryInitVideo(secureSrc, "é‡è¯•åŠ å¯†é“¾è·¯...");
                }

                if (!success && mounted) {
                  setState(() {
                    _isLoading = false;
                    _errorMessage = "è§†é¢‘åŠ è½½è¶…æ—¶/å¤±è´¥ã€‚";
                  });
                }
              } else {
                setState(() { _isLoading = false; });
              }
            }

            Future<bool> _tryInitVideo(String url, String statusMsg) async {
              try {
                if (mounted) setState(() => _loadingStatus = statusMsg);
                _videoController = VideoPlayerController.networkUrl(
                  Uri.parse(url),
                  videoPlayerOptions: VideoPlayerOptions(allowBackgroundPlayback: false),
                );
                
                // å¼ºåˆ¶ 12 ç§’å¿…é¡»ç»™å‡ºåˆå§‹åŒ–ç»“æœ
                await _videoController!.initialize().timeout(const Duration(seconds: 12));
                
                if (mounted) {
                  await _videoController!.setLooping(true);
                  await _videoController!.setVolume(1.0);
                  await _videoController!.play();
                  setState(() { 
                    _isInitialized = true; 
                    _isLoading = false; 
                    _timeoutTimer?.cancel();
                  });
                }
                return true;
              } catch (e) {
                return false;
              }
            }

            @override
            Widget build(BuildContext context) {
              if (project == null) return const Scaffold(body: Center(child: CircularProgressIndicator()));
              final nodes = project!['nodes'] as Map<String, dynamic>;
              final node = nodes[currentId];
              if (node == null) return const Scaffold(body: Center(child: Text('FINISH')));

              return Scaffold(
                backgroundColor: Colors.black,
                body: Stack(
                  children: [
                    // 1. è§†é¢‘èƒŒæ™¯å±‚
                    Positioned.fill(child: _buildMediaBackground(node)),
                    
                    // 2. æ¸å˜å åŠ ï¼ˆå¢å¼ºæ–‡æœ¬å¯è¯»æ€§ï¼‰
                    Positioned.fill(
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            stops: const [0.0, 0.4, 1.0],
                            colors: [
                              Colors.black.withOpacity(0.5),
                              Colors.transparent,
                              Colors.black.withOpacity(0.9),
                            ],
                          ),
                        ),
                      ),
                    ),

                    // 3. UI äº¤äº’å±‚
                    Positioned.fill(
                      child: SafeArea(
                        child: Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 50, vertical: 60),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              // æ ‡é¢˜åŒº
                              Row(
                                children: [
                                  Text(node['title'] ?? 'æœªå‘½åèŠ‚ç‚¹', 
                                    style: const TextStyle(fontSize: 40, fontWeight: FontWeight.bold, color: Colors.cyanAccent, letterSpacing: 1.5)),
                                  const Spacer(),
                                  if (_isLoading)
                                    Row(
                                      children: [
                                        const SizedBox(width: 15, height: 15, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.cyanAccent)),
                                        const SizedBox(width: 10),
                                        Text(_loadingStatus, style: const TextStyle(color: Colors.white54, fontSize: 11)),
                                      ],
                                    ),
                                ],
                              ),
                              const Spacer(),
                              // å‰§æƒ…æ–‡æœ¬
                              Container(
                                width: 600,
                                padding: const EdgeInsets.all(30),
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.4),
                                  borderRadius: BorderRadius.circular(20),
                                  border: Border.all(color: Colors.white10),
                                  backdropFilter: const ColorFilter.mode(Colors.black, BlendMode.dstIn),
                                ),
                                child: Text(node['content'] ?? '', 
                                  style: const TextStyle(fontSize: 20, height: 1.8, color: Colors.white, fontWeight: FontWeight.w300)),
                              ),
                              const SizedBox(height: 40),
                              // é€‰é¡¹åŒº
                              Wrap(
                                spacing: 20,
                                runSpacing: 20,
                                children: (node['options'] as List? ?? []).map((opt) => Material(
                                  color: Colors.transparent,
                                  child: InkWell(
                                    onTap: () {
                                      final targetId = opt['targetId']?.toString();
                                      if (targetId != null && targetId.isNotEmpty) {
                                        setState(() { currentId = targetId; });
                                        _setupMedia();
                                      }
                                    },
                                    borderRadius: BorderRadius.circular(10),
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 25),
                                      decoration: BoxDecoration(
                                        border: Border.all(color: Colors.cyanAccent.withOpacity(0.5)),
                                        borderRadius: BorderRadius.circular(10),
                                        color: Colors.cyanAccent.withOpacity(0.05),
                                      ),
                                      child: Text(opt['label'] ?? 'æœªå®šé€‰é¡¹', 
                                        style: const TextStyle(fontSize: 18, color: Colors.white, fontWeight: FontWeight.w500)),
                                    ),
                                  ),
                                )).toList(),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),

                    // 4. å³ä¸Šè§’è°ƒè¯•ä¿¡æ¯ï¼ˆä»…è§†é¢‘åŠ è½½å¤±è´¥æ˜¾ç¤ºï¼‰
                    if (_errorMessage != null)
                      Positioned(
                        top: 20, right: 20,
                        child: TextButton.icon(
                          onPressed: () => _setupMedia(),
                          icon: const Icon(Icons.refresh, color: Colors.orange, size: 14),
                          label: Text(_errorMessage!, style: const TextStyle(color: Colors.orange, fontSize: 10)),
                        ),
                      ),
                  ],
                ),
              );
            }

            Widget _buildMediaBackground(Map<String, dynamic> node) {
              if (_isInitialized && _videoController != null && _videoController!.value.isInitialized) {
                return SizedBox.expand(
                  child: FittedBox(
                    fit: BoxFit.cover,
                    child: SizedBox(
                      width: _videoController!.value.size.width,
                      height: _videoController!.value.size.height,
                      child: VideoPlayer(_videoController!),
                    ),
                  ),
                );
              }
              // å¦‚æœæ²¡æœ‰è§†é¢‘æˆ–æœªåŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºç§‘å¹»æ„Ÿé»‘æ´æ¸å˜
              return Container(
                decoration: const BoxDecoration(
                  gradient: RadialGradient(
                    center: Alignment.center,
                    radius: 1.5,
                    colors: [Color(0xFF0a192f), Colors.black],
                  ),
                ),
              );
            }
          }
          '@
          
          $dartCode.Trim() -replace '(?m)^\s{10}', '' | Out-File -FilePath "player_app/lib/main.dart" -Encoding utf8

      - name: 5. æ³¨å†Œèµ„æºä¸ä¾èµ–
        shell: pwsh
        run: |
          cd player_app
          flutter pub add video_player
          # è¿™é‡Œä¸æ˜¾å¼åŠ  video_player_winï¼Œå› ä¸ºå®˜æ–¹ video_player åœ¨æœ€æ–°ç‰ˆå·²ç»è‡ªåŠ¨é›†æˆäº† Windows æ”¯æŒ
          # æˆ‘ä»¬é‡ç‚¹ä¼˜åŒ– pubspec ç»“æ„
          $content = Get-Content pubspec.yaml
          $newContent = $content -replace '# assets:', "assets:`n    - assets/movie_config.json"
          Set-Content pubspec.yaml $newContent

      - name: 6. ç¼–è¯‘ Release EXE
        run: |
          cd player_app
          flutter pub get
          flutter build windows --release

      - name: 7. æ•´ç†å¹¶æ‰“åŒ…äº§ç‰©
        shell: pwsh
        run: |
          if (Test-Path "output") { Remove-Item -Recurse -Force "output" }
          New-Item -ItemType Directory -Path "output"
          Copy-Item "player_app/build/windows/x64/runner/Release/*" -Destination "output/" -Recurse
          Compress-Archive -Path "output/*" -DestinationPath "Douju_Player_Windows.zip" -Force

      - name: 8. ä¸Šä¼  Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Douju-Flutter-EXE-Build
          path: Douju_Player_Windows.zip
          retention-days: 7
