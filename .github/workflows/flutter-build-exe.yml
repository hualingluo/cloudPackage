name: ğŸ¬ æŠ–å‰§ Douju - Flutter EXE è‡ªåŠ¨åŒ–æ‰“åŒ…

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: 

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. åˆå§‹åŒ– Flutter é¡¹ç›®
        run: |
          flutter create --platforms=windows player_app
          cd player_app
          flutter config --enable-windows-desktop

      - name: 4. æ³¨å…¥æ™ºèƒ½æ’­æ”¾å™¨å¼•æ“
        shell: pwsh
        run: |
          if (!(Test-Path "player_app/assets")) { mkdir player_app/assets }
          
          # ä¼˜å…ˆä½¿ç”¨ project.jsonï¼Œå¦åˆ™ä½¿ç”¨ metadata.json
          if (Test-Path "project.json") {
              copy project.json player_app\assets\movie_config.json
          } else {
              copy metadata.json player_app\assets\movie_config.json
          }
          
          $dartCode = @'
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:video_player/video_player.dart';

void main() => runApp(const MovieApp());

class MovieApp extends StatelessWidget {
  const MovieApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Douju Player',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        primaryColor: Colors.cyan,
        useMaterial3: true,
      ),
      home: const MoviePlayer(),
    );
  }
}

class MoviePlayer extends StatefulWidget {
  const MoviePlayer({super.key});
  @override
  State<MoviePlayer> createState() => _MoviePlayerState();
}

class _MoviePlayerState extends State<MoviePlayer> {
  Map<String, dynamic>? project;
  String? currentId;
  VideoPlayerController? _videoController;
  bool _isInitialized = false;

  @override
  void initState() {
    super.initState();
    _loadProject();
  }

  @override
  void dispose() {
    _videoController?.dispose();
    super.dispose();
  }

  Future<void> _loadProject() async {
    try {
      final String response = await rootBundle.loadString('assets/movie_config.json');
      final data = await json.decode(response);
      setState(() {
        project = data;
        currentId = 'start';
      });
      _setupMedia();
    } catch (e) {
      debugPrint("Load Failed: $e");
    }
  }

  void _setupMedia() async {
    final nodes = project?['nodes'] as Map<String, dynamic>?;
    final node = nodes?[currentId];
    if (node == null) return;

    setState(() { _isInitialized = false; });
    await _videoController?.dispose();
    _videoController = null;

    final String mediaSrc = node['mediaSrc'] ?? '';
    final String mediaType = node['mediaType'] ?? 'none';
    
    // æ™ºèƒ½æ£€æµ‹ï¼šå¦‚æœåç¼€æ˜¯ .mp4 æˆ–è€… mediaType ä¸º video
    bool shouldPlayVideo = mediaType == 'video' || mediaSrc.toLowerCase().endsWith('.mp4');

    if (shouldPlayVideo && mediaSrc.isNotEmpty) {
      _videoController = VideoPlayerController.networkUrl(Uri.parse(mediaSrc));
      try {
        await _videoController!.initialize();
        await _videoController!.setLooping(true);
        await _videoController!.play();
        await _videoController!.setVolume(1.0);
        setState(() { _isInitialized = true; });
      } catch (e) {
        debugPrint("Video Init Error: $e");
      }
    } else {
      setState(() {});
    }
  }

  void _onOptionPressed(String targetId) {
    setState(() {
      currentId = targetId;
    });
    _setupMedia();
  }

  @override
  Widget build(BuildContext context) {
    if (project == null) return const Scaffold(body: Center(child: CircularProgressIndicator()));
    
    final nodes = project!['nodes'] as Map<String, dynamic>?;
    final node = nodes?[currentId];
    
    if (node == null) return const Scaffold(body: Center(child: Text('FINISH')));

    // å®‰å…¨å¤„ç† options
    final options = node['options'];
    final List<dynamic> optionList = (options is List) ? options : [];

    return Scaffold(
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          // Background Media
          Positioned.fill(
            child: _buildMediaBackground(node),
          ),
          
          // Overlay Gradient
          Positioned.fill(
            child: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [Colors.transparent, Colors.black.withOpacity(0.8)],
                ),
              ),
            ),
          ),

          // Content
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 60, vertical: 80),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    node['title'] ?? '', 
                    style: const TextStyle(fontSize: 48, fontWeight: FontWeight.bold, color: Colors.cyanAccent, shadows: [Shadow(blurRadius: 15, color: Colors.black)])
                  ),
                  const SizedBox(height: 24),
                  Text(
                    node['content'] ?? '', 
                    style: const TextStyle(fontSize: 22, height: 1.6, color: Colors.white, shadows: [Shadow(blurRadius: 8, color: Colors.black)])
                  ),
                  const SizedBox(height: 50),
                  if (optionList.isNotEmpty) 
                    Wrap(
                      spacing: 20,
                      runSpacing: 20,
                      children: optionList.map((opt) {
                        final label = opt['label']?.toString() ?? 'ç»§ç»­';
                        final targetId = opt['targetId']?.toString() ?? 'start';
                        return ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            padding: const EdgeInsets.symmetric(horizontal: 48, vertical: 28),
                            backgroundColor: Colors.cyan.withOpacity(0.1),
                            foregroundColor: Colors.white,
                            side: const BorderSide(color: Colors.cyanAccent, width: 1),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                          ),
                          onPressed: () => _onOptionPressed(targetId),
                          child: Text(label, style: const TextStyle(fontSize: 20)),
                        );
                      }).toList(),
                    ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMediaBackground(Map<String, dynamic> node) {
    final mediaSrc = node['mediaSrc'];

    if (_videoController != null && _isInitialized) {
      return SizedBox.expand(
        child: FittedBox(
          fit: BoxFit.cover,
          child: SizedBox(
            width: _videoController!.value.size.width,
            height: _videoController!.value.size.height,
            child: VideoPlayer(_videoController!),
          ),
        ),
      );
    } else if (mediaSrc != null && mediaSrc != "") {
      return Image.network(
        mediaSrc, 
        fit: BoxFit.cover, 
        errorBuilder: (c, e, s) => Container(color: Colors.grey[900])
      );
    }
    return Container(color: Colors.black);
  }
}
'@
          $dartCode | Out-File -FilePath player_app/lib/main.dart -Encoding utf8

      - name: 5. æ³¨å†Œèµ„æºä¸ä¾èµ–
        shell: pwsh
        run: |
          cd player_app
          
          # æ·»åŠ ä¾èµ–
          flutter pub add video_player
          
          # æ›´å®‰å…¨åœ°ä¿®æ”¹pubspec.yaml
          $pubspecContent = Get-Content pubspec.yaml -Raw
          
          # ç¡®ä¿flutteréƒ¨åˆ†å­˜åœ¨assetsé…ç½®
          if ($pubspecContent -match 'flutter:\s*\n(\s+)(.*?)\n\n') {
              $indent = $matches[1]
              $newContent = $pubspecContent -replace 'flutter:\s*\n(\s+)(.*?)\n\n', "flutter:`n${indent}assets:`n${indent}  - assets/movie_config.json`n`n"
          } else {
              # å¦‚æœæ ¼å¼ä¸åŒï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
              $pubspecContent += "`nflutter:`n  assets:`n    - assets/movie_config.json`n"
          }
          
          $pubspecContent | Set-Content pubspec.yaml -Encoding utf8

      - name: 6. ç¼–è¯‘ Release EXE
        run: |
          cd player_app
          flutter pub get
          flutter analyze  # æ·»åŠ åˆ†ææ­¥éª¤ï¼Œæ£€æŸ¥è¯­æ³•
          flutter build windows --release

      - name: 7. æ•´ç†äº§ç‰©
        shell: pwsh
        run: |
          mkdir output
          xcopy player_app\build\windows\x64\runner\Release\* output\ /E /H /C /I
          Compress-Archive -Path output\* -DestinationPath Douju_Player_Windows.zip

      - name: 8. å‘å¸ƒ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Douju-Flutter-EXE-Build
          path: Douju_Player_Windows.zip
          retention-days: 7
