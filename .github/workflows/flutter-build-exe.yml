
name: ğŸ¬ æŠ–å‰§ Douju - Flutter EXE è‡ªåŠ¨åŒ–æ‰“åŒ…

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æ‰“åŒ…

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. åˆå§‹åŒ– Flutter é¡¹ç›®
        run: |
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ flutter é¡¹ç›®ç”¨äºæ‰“åŒ…
          flutter create --platforms=windows player_app
          cd player_app
          # å¯ç”¨ Windows æ¡Œé¢æ”¯æŒ
          flutter config --enable-windows-desktop

      - name: 4. æ³¨å…¥æ’­æ”¾å™¨æ ¸å¿ƒä»£ç ä¸å‰§æœ¬æ•°æ®
        run: |
          # å‡†å¤‡èµ„æºç›®å½•
          mkdir player_app/assets
          # å°†æ ¹ç›®å½•çš„å‰§æœ¬æ•°æ®æ‹·è´åˆ°èµ„æºç›®å½• (é»˜è®¤ä½¿ç”¨ metadata.json ä½œä¸ºæ¼”ç¤ºå‰§æœ¬)
          copy metadata.json player_app\assets\movie_config.json
          
          # åˆ›å»º Dart æ’­æ”¾å™¨ä»£ç 
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªé¢„å®šä¹‰çš„ Dart æ¨¡æ¿ï¼Œå®ƒä¼šè¯»å– assets/movie_config.json
          $dartCode = @"
          import 'dart:convert';
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';

          void main() => runApp(const MovieApp());

          class MovieApp extends StatelessWidget {
            const MovieApp({super.key});
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Douju Player',
                theme: ThemeData.dark(),
                home: const MoviePlayer(),
              );
            }
          }

          class MoviePlayer extends StatefulWidget {
            const MoviePlayer({super.key});
            @override
            State<MoviePlayer> createState() => _MoviePlayerState();
          }

          class _MoviePlayerState extends State<MoviePlayer> {
            Map<String, dynamic>? project;
            String? currentId;

            @override
            void initState() {
              super.initState();
              _loadProject();
            }

            Future<void> _loadProject() async {
              final String response = await rootBundle.loadString('assets/movie_config.json');
              final data = await json.decode(response);
              setState(() {
                project = data;
                // é»˜è®¤ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æˆ–åä¸º start çš„èŠ‚ç‚¹å¼€å§‹
                currentId = 'start';
              });
            }

            @override
            Widget build(BuildContext context) {
              if (project == null) return const Scaffold(body: Center(child: CircularProgressIndicator()));
              
              final nodes = project!['nodes'] as Map<String, dynamic>?;
              final node = nodes?[currentId];
              
              if (node == null) return const Scaffold(body: Center(child: Text('å‰§ç»ˆæˆ–èŠ‚ç‚¹ä¸¢å¤±')));

              return Scaffold(
                backgroundColor: Colors.black,
                body: Stack(
                  children: [
                    if (node['mediaSrc'] != null && node['mediaSrc'] != "")
                      Positioned.fill(child: Image.network(node['mediaSrc'], fit: BoxFit.cover)),
                    
                    Align(
                      alignment: Alignment.bottomCenter,
                      child: Container(
                        padding: const EdgeInsets.all(32),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [Colors.transparent, Colors.black.withOpacity(0.8)],
                          ),
                        ),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(node['title'] ?? '', style: const TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Colors.cyanAccent)),
                            const SizedBox(height: 16),
                            Text(node['content'] ?? '', style: const TextStyle(fontSize: 18, height: 1.6)),
                            const SizedBox(height: 32),
                            Wrap(
                              spacing: 12,
                              runSpacing: 12,
                              children: (node['options'] as List).map((opt) => ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                                  backgroundColor: Colors.white10,
                                ),
                                onPressed: () => setState(() => currentId = opt['targetId']),
                                child: Text(opt['label']),
                              )).toList(),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          "@
          $dartCode | Out-File -FilePath player_app/lib/main.dart -Encoding utf8

      - name: 5. é…ç½®èµ„æºå¼•ç”¨ (pubspec.yaml)
        run: |
          # ä½¿ç”¨ PowerShell å¿«é€Ÿåœ¨ pubspec.yaml ä¸­æ·»åŠ  assets å£°æ˜
          cd player_app
          (Get-Content pubspec.yaml) -replace '# assets:', 'assets:' -replace '#   - images/a.png', '    - assets/movie_config.json' | Set-Content pubspec.yaml

      - name: 6. ç¼–è¯‘ Windows EXE
        run: |
          cd player_app
          flutter pub get
          flutter build windows --release

      - name: 7. æ‰“åŒ…äº§ç‰©
        run: |
          # å‹ç¼©æ„å»ºäº§ç‰©ä»¥ä¾¿ä¸‹è½½
          Compress-Archive -Path player_app\build\windows\x64\runner\Release\* -DestinationPath DoujuPlayer_Windows.zip

      - name: 8. ä¸Šä¼  Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Douju-Flutter-EXE
          path: DoujuPlayer_Windows.zip
          retention-days: 5
